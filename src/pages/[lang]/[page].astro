---
import { getCollection, type CollectionEntry } from 'astro:content';
import LandingLayout from '@/layouts/LandingLayout.astro';
import PostCardCover from '@/cards/PostCardCover.astro';

import Pagination from '@/features/Pagination.astro';
import CardWithPriority from '@/features/CardWithPriority.astro';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t } from '@/utils/translations';

import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const posts = await getCollection('post', (p) => !p.data.draft);
  const byLang = SUPPORTED_LANGS.flatMap((lang) => {
    const list = posts
      .filter((p) => p.data.locales === (lang as any))
      .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
    return paginate(list, { pageSize: 12, params: { lang } });
  });
  return byLang;
};

type Post = CollectionEntry<'post'>;

function toUrl(entry: Post, lang: Lang): string {
  const idWithoutExt = entry.id.replace(/\.(md|mdx|markdown)$/i, '');
  const slug = idWithoutExt.replace(new RegExp(`^${lang}/`), '');
  return `/${lang}/posts/${slug}/`;
}

const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;
const pageParam = Astro.params.page as string | undefined;
if (pageParam === '1') {
  return Astro.redirect(`/${lang}/`, 301);
}
const { page } = Astro.props as { page: any };
const items = (page?.data as Post[]) || [];

const h1 = t(lang, 'headings.home.h1');
const h2 = t(lang, 'headings.home.h2');
const title = t(lang, 'headings.home.title') || h1;
---

<LandingLayout lang={lang} title={title} canonical={Astro.url.href}>
  <fragment slot="header">
    <div class="sr-only">
      <h1>{h1}</h1>
      <h2>{h2}</h2>
      <p>{t(lang, 'site.description')}</p>
    </div>
  </fragment>

  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {
      items.map((p, idx) => (
        <CardWithPriority
          component={PostCardCover}
          index={idx}
          props={{
            href: toUrl(p, lang),
            imageSrc: p.data.heroImage,
            imageAlt: p.data.heroImageAlt,
            title: p.data.title,
            date: p.data.pubDate,
            category: p.data.category,
            lang,
            class: 'shadow-sm ring-1 ring-black/5 dark:ring-white/10',
          }}
        />
      ))
    }
  </div>

  <Pagination page={page} class="mt-10" />
</LandingLayout>
