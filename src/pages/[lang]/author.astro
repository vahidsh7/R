---
import fallbackAvatar from '@/assets/author.avif';
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import LandingLayout from '@/layouts/LandingLayout.astro';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t } from '@/utils/translations';
import GitHubActivityCalendar from '@/widgets/GitHubActivityCalendar.astro';
import LatestList from '@/widgets/LatestList.astro';
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;

const authors = await getCollection('author', (a) => !a.data.draft);
const pick = (l: Lang) => authors.find((a) => a.data.locales === l);
const entry = pick(lang) || pick(DEFAULT_LANG as Lang) || authors[0];

const authorName = entry?.data.name || 'Author';
const pageTitle = t(lang, 'pages.author.title') || (lang === 'zh' ? '作者' : 'Author');
const description = entry?.data.bio || '';
const socials: Array<{ label: string; url: string }> = (entry?.data.socials || []) as any;
const avatar = entry?.data.avatar || (fallbackAvatar as any);

function iconFor(label: string, url: string): string {
  const k = String(label || '').toLowerCase();
  if (k === 'x' || k === 'twitter') return 'tabler:brand-x';
  if (k === 'github') return 'mdi:github';
  if (k === 'rss' || url.endsWith('.xml')) return 'mdi:rss';
  if (k === 'website' || /^https?:\/\/.*/.test(url)) return 'mdi:web';
  return 'mdi:web';
}
function githubUsernameFromSocials(
  list: Array<{ label: string; url: string }>,
): string | undefined {
  for (const s of list) {
    const label = String(s.label || '').toLowerCase();
    const url = String(s.url || '');
    if (label === 'github' || /https?:\/\/([^\/]*\.)?github\.com\//i.test(url)) {
      try {
        const u = new URL(url.startsWith('http') ? url : `https://github.com/${url}`);
        const seg = (u.pathname || '/').split('/').filter(Boolean)[0];
        if (seg) return seg;
      } catch {}
      const m = url.match(/^@?([A-Za-z0-9-]{1,39})$/);
      if (m) return m[1];
    }
  }
  return undefined;
}
const githubUsername = githubUsernameFromSocials(socials);
const currentYear = new Date().getFullYear();
const years = [currentYear, currentYear - 1, currentYear - 2];
---

<LandingLayout
  lang={lang}
  title={pageTitle}
  description={description}
  canonical={Astro.url.href}
  image={avatar}
  imageAlt={authorName}
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <section
      class="rounded-3xl bg-white/80 p-8 shadow-lg shadow-black/5 backdrop-blur-xl transition-all duration-300 hover:shadow-xl hover:shadow-black/10 sm:p-12 lg:p-16 dark:bg-neutral-900/80 dark:shadow-white/5 dark:hover:shadow-white/10"
    >
      <div class="flex flex-col items-center gap-8 sm:flex-row sm:items-start sm:gap-12">
        <div class="shrink-0">
          <OptimizedPicture
            src={avatar}
            alt={authorName}
            width={160}
            height={160}
            class="h-32 w-32 rounded-full object-cover ring-2 ring-neutral-200 sm:h-40 sm:w-40 dark:ring-neutral-700"
            layout="fixed"
            fit="cover"
          />
        </div>

        <div class="w-full text-center sm:text-left">
          <h1 class="text-4xl font-bold tracking-tight sm:text-5xl lg:text-6xl">
            {authorName}
          </h1>
          <p class="mt-6 text-lg leading-relaxed text-neutral-600 sm:text-xl dark:text-neutral-400">
            {description}
          </p>

          {
            socials.length > 0 && (
              <div class="mt-8 flex flex-wrap items-center justify-center gap-3 sm:justify-start">
                {socials.map((s) => (
                  <a
                    href={s.url}
                    target={s.url.startsWith('http') ? '_blank' : undefined}
                    rel={s.url.startsWith('http') ? 'noopener noreferrer' : undefined}
                    class="group inline-flex items-center justify-center rounded-full bg-neutral-100 p-3 text-neutral-700 transition-all duration-200 hover:scale-110 hover:bg-neutral-900 hover:text-white hover:shadow-lg dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-white dark:hover:text-neutral-900"
                    aria-label={s.label}
                  >
                    <Icon
                      name={iconFor(s.label, s.url)}
                      class="h-5 w-5 transition-transform duration-200 group-hover:scale-110"
                    />
                  </a>
                ))}
              </div>
            )
          }
        </div>
      </div>
    </section>

    {
      githubUsername && (
        <section class="mt-24">
          <div class="relative overflow-hidden rounded-[2.5rem] bg-neutral-50 p-8 ring-1 ring-neutral-200/50 transition-all duration-500 hover:ring-neutral-300/50 sm:p-10 dark:bg-neutral-900/40 dark:ring-neutral-800 dark:hover:ring-neutral-700">
            <div class="flex flex-col gap-6">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h2 class="text-2xl font-semibold tracking-tight text-neutral-900 dark:text-white">
                  {t(lang, 'pages.author.writingActivity')}
                </h2>
              </div>

              <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:gap-6">
                <div class="min-w-0 flex-1">
                  <div class="relative">
                    {years.map((year) => (
                      <div data-calendar-year={year} class={year === currentYear ? '' : 'hidden'}>
                        <GitHubActivityCalendar
                          username="idimilabs"
                          repo="idimilabs/Astrology-i18n"
                          year={year}
                        />
                      </div>
                    ))}
                  </div>
                </div>

                <div class="shrink-0">
                  <div
                    class="flex flex-row flex-wrap items-center justify-start gap-2 text-neutral-700 lg:flex-col lg:items-end lg:gap-2.5 dark:text-neutral-200"
                    id="year-selector"
                  >
                    {years.map((year) => (
                      <button
                        type="button"
                        data-year={year}
                        class={`group inline-flex min-w-[70px] items-center justify-center rounded-full px-5 py-2 text-sm font-semibold transition-all duration-200 ${
                          year === currentYear
                            ? '-translate-y-px bg-neutral-900 text-white shadow-lg ring-1 shadow-neutral-900/10 ring-neutral-900/40 dark:bg-white dark:text-neutral-900 dark:shadow-white/10 dark:ring-white/30'
                            : 'text-neutral-600 ring-1 ring-neutral-200 hover:-translate-y-px hover:bg-neutral-900/5 dark:text-neutral-400 dark:ring-neutral-800 dark:hover:bg-neutral-800 dark:hover:text-white'
                        }`}
                      >
                        {year}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      )
    }

    <LatestList lang={lang} class="mt-12" />
  </div>
</LandingLayout>

<script
  type="application/ld+json"
  is:inline
  set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'Person',
    name: authorName,
    url: Astro.url.href,
    image: (() => {
      const av = avatar as any;
      const src = typeof av === 'string' ? av : (av?.src ?? '');
      if (!src) return '';
      return src.startsWith('http://') || src.startsWith('https://')
        ? src
        : new URL(src, Astro.site!).href;
    })(),
    sameAs: socials.map((s) => s.url),
    description,
  })}
/>

<script>
  import { registerPageInit } from '@/utils/page-init';

  function initYearSelector() {
    const yearButtons = document.querySelectorAll('#year-selector button[data-year]');
    const calendars = document.querySelectorAll('[data-calendar-year]');

    if (yearButtons.length === 0 || calendars.length === 0) {
      return;
    }

    const activeClasses = [
      'bg-neutral-900',
      'text-white',
      'shadow-lg',
      'shadow-neutral-900/10',
      'ring-1',
      'ring-neutral-900/40',
      '-translate-y-px',
      'dark:bg-white',
      'dark:text-neutral-900',
      'dark:shadow-white/10',
      'dark:ring-white/30',
    ];
    const inactiveClasses = [
      'ring-1',
      'ring-neutral-200',
      'text-neutral-600',
      'hover:-translate-y-px',
      'hover:bg-neutral-900/5',
      'dark:text-neutral-400',
      'dark:ring-neutral-800',
      'dark:hover:bg-neutral-800',
      'dark:hover:text-white',
    ];

    function handleYearClick(event: Event) {
      const button = event.currentTarget as HTMLButtonElement;
      if (!button) return;
      const selectedYear = button.getAttribute('data-year');

      yearButtons.forEach((btn) => {
        if (btn === button) {
          btn.classList.remove(...inactiveClasses);
          btn.classList.add(...activeClasses);
        } else {
          btn.classList.remove(...activeClasses);
          btn.classList.add(...inactiveClasses);
        }
      });

      calendars.forEach((calendar) => {
        const calendarYear = calendar.getAttribute('data-calendar-year');
        if (calendarYear === selectedYear) {
          calendar.classList.remove('hidden');
        } else {
          calendar.classList.add('hidden');
        }
      });
    }

    // 移除旧的事件监听器
    yearButtons.forEach((button) => {
      button.removeEventListener('click', handleYearClick);
    });

    // 添加新的事件监听器
    yearButtons.forEach((button) => {
      button.addEventListener('click', handleYearClick);
    });

    // 返回清理函数
    return () => {
      yearButtons.forEach((button) => {
        button.removeEventListener('click', handleYearClick);
      });
    };
  }

  registerPageInit('yearSelector', initYearSelector);
</script>
