---
import type { Lang } from '@/utils/i18n';
import { SUPPORTED_LANGS, toAbsolute } from '@/utils/i18n';
import { t } from '@/utils/translations';

interface Props {
  lang?: Lang;
  class?: string;
}

const { lang, class: className } = Astro.props as Props;
const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (lang as Lang | undefined) ??
  'zh') as Lang;

const FLAG_MAP: Record<Lang, string> = {
  zh: 'ğŸ‡¨ğŸ‡³',
  en: 'ğŸ‡ºğŸ‡¸',
  fr: 'ğŸ‡«ğŸ‡·',
  es: 'ğŸ‡ªğŸ‡¸',
  ru: 'ğŸ‡·ğŸ‡º',
  ja: 'ğŸ‡¯ğŸ‡µ',
  ko: 'ğŸ‡°ğŸ‡·',
  pt: 'ğŸ‡µğŸ‡¹',
  de: 'ğŸ‡©ğŸ‡ª',
  id: 'ğŸ‡®ğŸ‡©',
  ar: 'ğŸ‡¸ğŸ‡¦',
};
const currentFlag = FLAG_MAP[resolvedLang] ?? 'ğŸŒ';
---

<details class={`relative ${className ?? ''}`.trim()} data-lang-root>
  <summary
    class="cursor-pointer rounded-md p-2 text-neutral-700 select-none hover:bg-neutral-100 dark:text-neutral-300 dark:hover:bg-neutral-800"
  >
    <span aria-hidden="true">{currentFlag}</span>
    <span class="sr-only">{t(resolvedLang, 'language.switch')}</span>
  </summary>
  <div
    class="nav-dropdown absolute top-full left-1/2 z-50 mt-1 min-w-40 -translate-x-1/2 rounded-lg py-1.5 shadow-xl"
  >
    {
      SUPPORTED_LANGS.map((l) => (
        <a
          href={toAbsolute(l, Astro.url.pathname)}
          class={`flex w-full items-center gap-2 rounded-sm px-2.5 py-1.5 text-sm transition-colors hover:bg-black/20 hover:text-black dark:hover:bg-white/15 dark:hover:text-white ${l === resolvedLang ? 'font-medium text-black dark:text-white' : 'text-neutral-700 dark:text-neutral-300'}`}
        >
          <span aria-hidden="true">{FLAG_MAP[l] ?? 'ğŸŒ'}</span>
          <span>{t(l, 'language.name')}</span>
        </a>
      ))
    }
  </div>
</details>

<script>
  import { registerPageInit } from '@/utils/page-init';

  registerPageInit('languageSwitcher', () => {
    const langRoot = document.querySelector('[data-lang-root]');
    if (!langRoot) return;

    let closeTimeout: ReturnType<typeof setTimeout> | null = null;

    function handleMouseLeave() {
      closeTimeout = setTimeout(() => {
        if (langRoot instanceof HTMLDetailsElement) {
          langRoot.open = false;
        }
      }, 150);
    }

    function handleMouseEnter() {
      if (closeTimeout) {
        clearTimeout(closeTimeout);
        closeTimeout = null;
      }
    }

    langRoot.addEventListener('mouseleave', handleMouseLeave);
    langRoot.addEventListener('mouseenter', handleMouseEnter);

    return () => {
      langRoot.removeEventListener('mouseleave', handleMouseLeave);
      langRoot.removeEventListener('mouseenter', handleMouseEnter);
      if (closeTimeout) clearTimeout(closeTimeout);
    };
  });
</script>

<style>
  details[data-lang-root] > summary::-webkit-details-marker {
    display: none;
  }
  details[data-lang-root] > summary {
    list-style: none;
  }
</style>
