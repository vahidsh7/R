---
import type { Lang } from '@/utils/i18n';
import { t } from '@/utils/translations';
import LanguageSwitcher from '@/features/LanguageSwitcher.astro';
import ThemeSwitcher from '@/features/ThemeSwitcher.astro';
import MainNav from '@/ui/MainNav.astro';
import MobileNav from '@/ui/MobileNav.astro';
import { Icon } from 'astro-icon/components';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { Image } from 'astro:assets';
import logo from '@/assets/logo.svg';

const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (Astro.props.lang as Lang | undefined) ??
  'zh') as Lang;

const siteName = t(resolvedLang, 'site.name');
---

<header class="header-glass w-full">
  <div class="mx-auto max-w-6xl px-4 sm:px-6">
    <div class="grid h-14 grid-cols-[1fr_auto_1fr] items-center gap-3">
      <a
        href={getRelativeLocaleUrl(resolvedLang, '/')}
        class="flex items-center gap-2.5 justify-self-start text-xl font-semibold tracking-tight hover:opacity-90"
      >
        <Image src={logo} alt="Logo" class="h-6 w-6" loading="eager" />
        <span class="text-xl text-neutral-900 dark:text-neutral-100">
          {siteName}
        </span>
      </a>

      <div class="justify-self-center">
        <MainNav lang={resolvedLang} />
      </div>

      <div class="flex items-center gap-2 justify-self-end">
        <a
          href="https://chat.idimi.com"
          target="_blank"
          rel="noopener noreferrer"
          aria-label={t(resolvedLang, 'chat.title')}
          title={t(resolvedLang, 'chat.title')}
          class="rounded-md p-2 text-neutral-600 transition-colors hover:bg-black/5 hover:text-black dark:text-neutral-300 dark:hover:bg-white/10 dark:hover:text-white"
        >
          <Icon name="lucide:search" />
        </a>

        <LanguageSwitcher lang={resolvedLang} />

        <ThemeSwitcher lang={resolvedLang} />

        <button
          type="button"
          class="rounded-md p-2 text-neutral-600 transition-colors hover:bg-black/5 hover:text-black lg:hidden dark:text-neutral-300 dark:hover:bg-white/10 dark:hover:text-white"
          aria-label="Menu"
          data-mobile-trigger
        >
          <Icon name="lucide:menu" />
        </button>
      </div>
    </div>
  </div>

  <MobileNav lang={resolvedLang} />
</header>

<script>
  import { registerPageInit } from '@/utils/page-init';

  registerPageInit('mobileMenu', () => {
    const btn = document.querySelector('[data-mobile-trigger]');
    if (!btn) return;

    function handleMobileToggle() {
      const panel = document.querySelector('[data-mobile-panel]');
      if (panel) panel.classList.toggle('hidden');
    }

    btn.addEventListener('click', handleMobileToggle);

    // Return cleanup function
    return () => {
      btn.removeEventListener('click', handleMobileToggle);
    };
  });
</script>
