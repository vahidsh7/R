---
import type { Lang } from '@/utils/i18n';
import { t } from '@/utils/translations';
import { NAV_ITEMS } from '@/utils/navItems';
import { getRelativeLocaleUrl } from 'astro:i18n';

interface Props {
  lang?: Lang;
  class?: string;
}
const { lang, class: className } = Astro.props as Props;
const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (lang as Lang | undefined) ??
  'zh') as Lang;
const alignmentClass = resolvedLang === 'ar' ? 'text-right' : 'text-left';
---

<div class={`lg:hidden hidden glass ${className ?? ''}`.trim()} data-mobile-panel>
  <div class="mx-auto max-w-6xl px-4 py-3 sm:px-6">
    <div class="space-y-2">
      {
        NAV_ITEMS.map((item, i) =>
          item.tags && item.tags.length > 0 ? (
            <div class="overflow-hidden rounded-lg border border-white/10">
              <button
                type="button"
                class={`flex w-full items-center justify-between bg-white/5 px-3 py-2.5 ${alignmentClass} text-sm font-semibold text-neutral-100`}
                data-accordion-trigger={`m-${i}`}
              >
                <span>{t(resolvedLang, `navigation.${item.key}`)}</span>
                <svg
                  class="h-4 w-4 text-neutral-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                  aria-hidden="true"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.086l3.71-3.855a.75.75 0 111.08 1.04l-4.24 4.405a.75.75 0 01-1.08 0L5.25 8.27a.75.75 0 01-.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div class="hidden bg-white/5 px-3 py-2" data-accordion-panel={`m-${i}`}>
                <a
                  href={getRelativeLocaleUrl(resolvedLang, `/category/${item.key}`)}
                  class="block rounded px-2 py-1.5 text-sm text-neutral-300 transition-colors hover:bg-white/10 hover:text-white"
                >
                  {t(resolvedLang, `navigation.${item.key}`)}
                </a>
                <div class="mt-1 space-y-1 border-t border-white/10 pt-2">
                  {item.tags.map((tag) => (
                    <a
                      href={getRelativeLocaleUrl(resolvedLang, `/tags/${tag}`)}
                      class="block rounded px-2 py-1.5 text-sm text-neutral-300 transition-colors hover:bg-white/10 hover:text-white"
                    >
                      {t(resolvedLang, `tags.${tag}`)}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <a
              href={getRelativeLocaleUrl(resolvedLang, `/category/${item.key}`)}
              class="block rounded-lg border border-white/10 bg-white/5 px-3 py-2.5 text-sm font-semibold text-neutral-100 transition-colors hover:bg-white/10"
            >
              {t(resolvedLang, `navigation.${item.key}`)}
            </a>
          ),
        )
      }
    </div>
  </div>
</div>

<script>
  import { registerPageInit } from '@/utils/page-init';

  registerPageInit('mobileAccordion', () => {
    const root = document.querySelector('[data-mobile-panel]');
    if (!root) return;

    function handleAccordionClick(e: Event) {
      const target = e.target;
      if (!(target instanceof Element)) return;

      const trigger = target.closest('[data-accordion-trigger]');
      if (!trigger) return;

      const id = trigger.getAttribute('data-accordion-trigger');
      if (!id) return;

      const panel = root.querySelector(`[data-accordion-panel="${id}"]`);
      if (panel) panel.classList.toggle('hidden');
    }

    root.addEventListener('click', handleAccordionClick);

    // Return cleanup function
    return () => {
      root.removeEventListener('click', handleAccordionClick);
    };
  });
</script>
