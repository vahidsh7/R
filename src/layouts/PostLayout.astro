---
import MainLayout from '@/layouts/MainLayout.astro';
import BaseHeader from '@/ui/BaseHeader.astro';
import Prose from '@/features/Prose.astro';
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import { Image } from 'astro:assets';
import authorAvatar from '@/assets/author.avif';
import type { Lang } from '@/utils/i18n';
import { t, categoryLabel as i18nCategoryLabel, categorySlug } from '@/utils/translations';
import { formatDate } from '@/utils/date';
import { getRelativeLocaleUrl } from 'astro:i18n';

interface Props {
  lang?: Lang;
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  canonical?: string;
  noindex?: boolean;
  publishedTime?: string | Date | undefined;
  modifiedTime?: string | Date | undefined;
  author?: string;
  authorUrl?: string;
  section?: string;
  tags?: string[];
  noProse?: boolean;
}

const {
  lang: langProp = 'zh',
  title,
  description,
  image,
  imageAlt,
  canonical,
  noindex,
  publishedTime,
  modifiedTime,
  author,
  authorUrl,
  section,
  tags = [],
} = Astro.props as Props;
const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (langProp as Lang | undefined) ??
  'zh') as Lang;

const fmt = (d?: string | Date) => formatDate(d, resolvedLang);

const categoryLabel = i18nCategoryLabel(resolvedLang, section);
const categoryKey = categorySlug(resolvedLang, section);
const headerProps = {
  lang: resolvedLang,
  title,
  ...(description ? { description } : {}),
  ...(image ? { image } : {}),
  ...(imageAlt ? { imageAlt } : {}),
  ...(publishedTime ? { publishedTime } : {}),
  ...(modifiedTime ? { modifiedTime } : {}),
  ...(canonical ? { canonical } : {}),
  ...(typeof noindex === 'boolean' ? { noindex } : {}),
  ...(author ? { authorName: author } : {}),
  ...(authorUrl ? { authorUrl } : {}),
  ...(section ? { section } : {}),
  ...(Array.isArray(tags) && tags.length ? { tags } : {}),
  breadcrumbs: [
    {
      name: t(resolvedLang, 'site.name') || 'iDiMi',
      item: getRelativeLocaleUrl(resolvedLang, '/'),
    },
    ...(section
      ? [
          {
            name: categoryLabel ?? '',
            item: getRelativeLocaleUrl(
              resolvedLang,
              `/category/${encodeURIComponent(categoryKey ?? '')}`,
            ),
          },
        ]
      : []),
    { name: title, item: Astro.url.href },
  ],
};
const pagePath = Astro.url?.pathname ?? '';
---

<MainLayout lang={resolvedLang}>
  <BaseHeader {...headerProps} slot="head" />
  <div
    slot="hero"
    class="relative z-10 mx-auto mt-10 w-full max-w-3xl px-4 sm:px-5 md:px-6"
    data-glass-card
  >
    <div
      class="post-card-desc group relative flex aspect-[3/4] flex-col overflow-hidden rounded-2xl md:aspect-[16/9] md:rounded-3xl"
    >
      {
        image && (
          <OptimizedPicture
            src={image}
            alt={imageAlt || title}
            class="absolute inset-0 h-full w-full object-cover object-center transition-transform duration-[800ms] ease-[cubic-bezier(0.4,0,0.2,1)] group-hover:scale-[1.03]"
            fit="cover"
            position="center"
            priority={true}
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 75vw, 768px"
          />
        )
      }

      <div
        class="absolute right-1.5 bottom-1.5 left-1.5 flex flex-col justify-end rounded-xl border border-white/15 p-4 shadow-lg backdrop-blur-xl sm:p-5 md:px-10 md:py-6 lg:px-12 lg:py-8"
        data-glass-target
      >
        <div class="mx-auto flex w-full max-w-4xl flex-col md:flex-col-reverse md:gap-4">
          <div
            class="mb-2 flex items-center justify-between text-white/90 md:mb-0 md:justify-center md:gap-4"
          >
            {
              section ? (
                <a
                  href={getRelativeLocaleUrl(
                    resolvedLang,
                    `/category/${encodeURIComponent(categoryKey ?? '')}`,
                  )}
                  class="rounded-full bg-white/25 px-3 py-1 text-[10px] font-semibold tracking-wide text-white uppercase transition-colors hover:bg-white/40 sm:text-xs"
                >
                  {categoryLabel}
                </a>
              ) : (
                <span />
              )
            }
            {
              publishedTime && (
                <time
                  datetime={new Date(publishedTime).toISOString()}
                  class="text-xs font-medium opacity-80 sm:text-sm"
                >
                  {fmt(publishedTime)}
                </time>
              )
            }
          </div>

          <h1
            class="text-left text-base font-bold tracking-tight text-balance text-white sm:text-lg md:text-center md:text-xl lg:text-2xl"
          >
            {title}
          </h1>
        </div>
      </div>
    </div>
  </div>

  {
    Astro.props.noProse ? (
      <slot />
    ) : (
      <Prose>
        <slot />
        {(publishedTime || modifiedTime) && (
          <p class="mt-6 text-xs text-neutral-500 dark:text-neutral-400">
            {publishedTime && (
              <>
                {t(resolvedLang, 'post.publishedAt')}: {fmt(publishedTime)}
              </>
            )}
            {publishedTime && modifiedTime && ' Â· '}
            {modifiedTime && (
              <>
                {t(resolvedLang, 'post.modifiedAt')}: {fmt(modifiedTime)}
              </>
            )}
          </p>
        )}
        {(section || author) && (
          <div class="mt-2 flex items-center justify-between">
            {author ? (
              <a
                href={getRelativeLocaleUrl(resolvedLang, '/author/')}
                class="flex items-center gap-3 text-xs text-neutral-600 no-underline transition-opacity hover:no-underline hover:opacity-70 focus:no-underline dark:text-neutral-300"
              >
                <Image
                  src={authorAvatar}
                  alt={author}
                  width={32}
                  height={32}
                  class="rounded-full"
                />
                <span>{author}</span>
              </a>
            ) : (
              <span />
            )}
            <div class="flex items-center gap-2">
              {section ? (
                <a
                  href={getRelativeLocaleUrl(
                    resolvedLang,
                    `/category/${encodeURIComponent(categoryKey ?? '')}`,
                  )}
                  class="inline-flex items-center rounded-full bg-neutral-100 px-2.5 py-0.5 text-xs font-medium text-neutral-700 no-underline hover:bg-neutral-200 hover:no-underline focus:no-underline dark:bg-neutral-800 dark:text-neutral-300"
                  aria-label={`Category: ${categoryLabel}`}
                >
                  {categoryLabel}
                </a>
              ) : (
                <span />
              )}
              {pagePath && (
                <span
                  class="waline-pageview-count inline-flex items-center rounded-full bg-neutral-100 px-2.5 py-0.5 text-xs font-medium text-neutral-700 no-underline hover:bg-neutral-200 hover:no-underline focus:no-underline dark:bg-neutral-800 dark:text-neutral-300"
                  data-path={pagePath}
                >
                  --
                </span>
              )}
            </div>
          </div>
        )}
      </Prose>
    )
  }
  <slot name="after" />
</MainLayout>

<style is:global>
  /* Hide the first image in article content (usually a duplicate cover image) */
  .prose > figure:first-child {
    display: none;
  }
</style>
